<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mattresses</title>

  <!-- Estilo global -->
  <link rel="stylesheet" href="../../style.css" />

  <!-- Firebase -->
  <script type="module" src="../../js/firebase.js"></script>
</head>
<body>

  <!-- Top bar -->
  <div class="top-bar">
    <div>üìç Furniture store in Fairfield, OH | üöö Delivering to <strong>0000</strong></div>
    <div>
      <a href="../../login.html" data-login-link>Login</a>
      <a href="#" data-logout-link style="display:none" onclick="FB.logout()">Logout</a>
      <a href="#" id="financing-btn">Financing</a>
      <a href="#" id="help-btn">Help</a>
      <a href="../../cart.html">üõí (<span id="cart-count">0</span>)</a>
      <span data-user-badge style="margin-left:8px;opacity:.8">Invitado</span>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search mattresses...">
    </div>
    <div class="logo">
      <a href="../../index.html"><img src="../../logo.jfif" alt="Logo"></a>
    </div>
    <div>üìû Shop by phone 000-000-0000</div>
  </div>

  <!-- Nav -->
  <div class="nav">
    <a href="../livingroom/livingroom.html">LIVING ROOM</a>
    <a href="../bedroom/bedroom.html">BEDROOM</a>
    <a href="../dining/dining.html">DINING</a>
    <a class="active" href="../mattresses/mattresses.html">MATTRESSES</a>
    <a href="../outdoor/outdoor.html">OUTDOOR</a>
    <a href="../kids/kids.html">BABY & KIDS</a>
    <a href="../rugs/rugs.html">RUGS</a>
    <a href="../accents/accents.html">ACCENTS & DECOR</a>
  </div>

  <!-- Contenido -->
  <div class="content">
    <button id="filter-toggle" class="filter-toggle" onclick="toggleFilters()">‚ò∞ Filters</button>

    <aside id="filters" class="filters">
      <div class="filters-header">
        <strong>Filters</strong>
        <button class="filters-close-btn" type="button" aria-label="Close">‚úï</button>
      </div>

      <h3>Filters</h3>

      <label for="minPriceFilter">Min Price:</label>
      <input type="number" id="minPriceFilter" placeholder="e.g. 100">

      <label for="maxPriceFilter">Max Price:</label>
      <input type="number" id="maxPriceFilter" placeholder="e.g. 2000">

      <label for="sizeFilter">Size:</label>
      <select id="sizeFilter">
        <option value="">All</option>
        <option value="twin">Twin</option>
        <option value="full">Full</option>
        <option value="queen">Queen</option>
        <option value="king">King</option>
        <option value="california king">California King</option>
      </select>

      <label for="firmnessFilter">Firmness:</label>
      <select id="firmnessFilter">
        <option value="">All</option>
        <option value="soft">Soft</option>
        <option value="medium">Medium</option>
        <option value="medium-firm">Medium-Firm</option>
        <option value="firm">Firm</option>
      </select>

      <label for="thicknessFilter">Thickness:</label>
      <select id="thicknessFilter">
        <option value="">All</option>
        <option value="8 inch">8 Inch</option>
        <option value="10 inch">10 Inch</option>
        <option value="12 inch">12 Inch</option>
        <option value="14 inch">14 Inch</option>
      </select>

      <label for="materialFilter">Material:</label>
      <select id="materialFilter">
        <option value="">All</option>
        <option value="memory foam">Memory Foam</option>
        <option value="gel memory foam">Gel Memory Foam</option>
        <option value="innerspring">Innerspring</option>
        <option value="hybrid">Hybrid</option>
      </select>

      <button onclick="applyFilters()">Apply Filters</button>
    </aside>

    <div class="products" id="products"></div>
  </div>

  <div class="chat">üí¨ Chat With Us</div>

  <!-- Script principal -->
  <script>
    // Helpers
    const escapeHtml = s => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const normalizeImage = (p) => {
      if (!p) return "../../imgpromo/placeholder.jpg";
      if (/^https?:\/\//i.test(p)) return p;
      if (p.startsWith("../../")) return p;
      // esta p√°gina vive en /pages/mattresses/ ‚Äî subimos dos niveles
      return "../../" + p.replace(/^\/+/, "");
    };

    // Cargar productos
    fetch('mattresses.json')
      .then(res => {
        if (!res.ok) throw new Error("Could not load mattresses.json");
        return res.json();
      })
      .then(data => {
        const container = document.getElementById("products");

        function hrefFor(prod) {
          return '../../producto.html?id=' + encodeURIComponent(prod.id) + '&cat=mattresses';
        }

        function renderProducts(list) {
          container.innerHTML = "";
          if (!list?.length) {
            container.innerHTML = "<p class='no-results'>No products found.</p>";
            return;
          }

          list.forEach(prod => {
            const img = normalizeImage(Array.isArray(prod.images) && prod.images[0] ? prod.images[0] : "");
            const name = prod.name || "";
            const price = Number(prod.price || 0);

            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
              <a href="${hrefFor(prod)}">
                <img src="${escapeHtml(img)}" alt="${escapeHtml(name)}">
                <h3>${escapeHtml(name)}</h3>
                <p>$${price.toFixed(2)}</p>
              </a>
              <button class="buy-btn"
                      data-id="${escapeHtml(String(prod.id))}"
                      data-name="${escapeHtml(name)}"
                      data-price="${price}"
                      data-image="${escapeHtml(img)}">üõí Buy</button>
            `;
            container.appendChild(card);
          });
        }

        renderProducts(data);

        // B√∫squeda
        document.getElementById("searchInput").addEventListener("input", e => {
          const text = (e.target.value || "").toLowerCase();
          const filtered = !text ? data : data.filter(p =>
            (p.name && p.name.toLowerCase().includes(text)) ||
            (p.description && p.description.toLowerCase().includes(text))
          );
          renderProducts(filtered);
        });

        // Filtros
        function applyFilters() {
          const min = parseFloat(document.getElementById("minPriceFilter").value) || 0;
          const max = parseFloat(document.getElementById("maxPriceFilter").value) || Infinity;
          const size = document.getElementById("sizeFilter").value.toLowerCase();
          const firmness = document.getElementById("firmnessFilter").value.toLowerCase();
          const thickness = document.getElementById("thicknessFilter").value.toLowerCase();
          const material = document.getElementById("materialFilter").value.toLowerCase();

          const filtered = data.filter(p =>
            Number(p.price || 0) >= min &&
            Number(p.price || 0) <= max &&
            (size === "" || (p.size && String(p.size).toLowerCase() === size)) &&
            (firmness === "" || (p.firmness && String(p.firmness).toLowerCase() === firmness)) &&
            (thickness === "" || (p.thickness && String(p.thickness).toLowerCase() === thickness)) &&
            (material === "" || (p.material && String(p.material).toLowerCase() === material))
          );
          renderProducts(filtered);
        }

        function toggleFilters() {
          document.getElementById("filters").classList.toggle("open");
        }

        // Exponer para onclicks del HTML
        window.applyFilters = applyFilters;
        window.toggleFilters = toggleFilters;

        // Delegaci√≥n para botones Buy
        container.addEventListener("click", e => {
          if (e.target.matches(".buy-btn")) {
            const btn = e.target;
            addToCart(btn.dataset.id, btn.dataset.name, Number(btn.dataset.price), btn.dataset.image);
          }
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById("products").innerHTML =
          "<p style='padding:20px;color:#c00'>Error loading products. Check console.</p>";
      });

    // ====== Carrito ======
    let cart = JSON.parse(localStorage.getItem("cart")) || [];

    function updateCartCount() {
      const el = document.getElementById("cart-count");
      if (el) el.textContent = (cart || []).reduce((s, i) => s + Number(i.quantity || 0), 0);
    }

    function lsSet(items) {
      localStorage.setItem("cart", JSON.stringify(items));
      updateCartCount();
    }

    async function addToCart(id, name, price, image) {
      const item = { id, name, price: Number(price || 0), image: image || "", quantity: 1 };
      const useFirebase = window.FB && FB.auth && FB.auth.currentUser && typeof FB.addToCart === "function";

      try {
        if (useFirebase) {
          await FB.addToCart(item);
        } else {
          const found = cart.find(p => String(p.id) === String(id));
          if (found) found.quantity = Number(found.quantity || 0) + 1;
          else cart.push(item);
          lsSet(cart);
        }
        if (!useFirebase) updateCartCount();
        alert(name + " added to cart ‚úÖ");
      } catch (err) {
        console.error(err);
        alert("Could not add to cart: " + (err.message || err));
      }
    }

    window.onload = updateCartCount;
    window.addEventListener("storage", e => {
      if (e.key === "cart") {
        cart = JSON.parse(localStorage.getItem("cart")) || [];
        updateCartCount();
      }
    });
  </script>

  <!-- Scripts globales -->
  <script src="../../js/modals.js" defer></script>
  <script src="../../js/chat-widget.js" defer></script>

  <!-- UX filtros -->
  <script>
    (function () {
      const panel = document.getElementById('filters');
      if (!panel) return;

      let overlay = panel.nextElementSibling;
      if (!(overlay && overlay.classList.contains('filters-overlay'))) {
        const stray = document.querySelector('.filters-overlay');
        if (stray && stray !== overlay) stray.remove();
        overlay = document.createElement('div');
        overlay.className = 'filters-overlay';
        panel.parentNode.insertBefore(overlay, panel.nextElementSibling);
      }

      const closeBtn = panel.querySelector('.filters-close-btn');

      function sync() {
        const open = panel.classList.contains('open');
        overlay.style.display = open ? 'block' : 'none';
        document.body.classList.toggle('body-no-scroll', open);
      }

      closeBtn && closeBtn.addEventListener('click', () => { panel.classList.remove('open'); sync(); });
      overlay.addEventListener('click', () => { panel.classList.remove('open'); sync(); });
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && panel.classList.contains('open')) { panel.classList.remove('open'); sync(); }
      });

      const applyBtn = panel.querySelector("button[onclick*='applyFilters']");
      if (applyBtn && !applyBtn.__wired) {
        applyBtn.addEventListener('click', () => setTimeout(() => { panel.classList.remove('open'); sync(); }, 0));
        applyBtn.__wired = true;
      }
    })();
  </script>

    <!-- Firebase base -->
    <script type="module" src="js/firebase.js"></script>
    <!-- Script espec√≠fico del login -->
    <script type="module" src="js/auth.js"></script>
  </body>
  </html>
</body>
</html>