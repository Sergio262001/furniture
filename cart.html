<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mi Carrito - Ashley Clone</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase (usa tu config en /js/firebase.js) -->
  <script type="module" src="js/firebase.js"></script>
</head>
<body>

  <!-- Reutilizable: Header global Furniture -->
  <div id="site-header"></div>

  <!-- Aseg√∫rate de cargar firebase.js ANTES del header -->
  <script type="module" src="js/firebase.js"></script>
  <script type="module" src="js/site-header.js"></script>

  <!-- üîπ TOP BAR (login/logout din√°mico) -->
  <div class="top-bar">
    <div>üìç Furniture store in Fairfield, OH | üöö Delivering to <strong>0000</strong></div>
    <div>
      <a href="login.html" data-login-link>Login</a>
      <a href="#" data-logout-link style="display:none">Logout</a>
      <a href="#" id="financing-btn">Financing</a>
      <a href="#" id="help-btn">Help</a>
      <a href="cart.html">üõí (<span id="cart-count">0</span>)</a>
      <span data-user-badge style="margin-left:8px;opacity:.8">Invitado</span>
    </div>
  </div>

  <!-- üîπ HEADER -->
  <div class="header">
    <div class="logo">
      <a href="index.html"><img src="logo.jfif" alt="Ashley Logo" /></a>
    </div>
    <div class="cart-header">
      <h1>üõí Mi Carrito</h1>
    </div>
  </div>

  <!-- üîπ CONTENEDOR DEL CARRITO (BLOQUE 1) -->
  <div class="cart-container">
    <div id="cart-items" class="cart-items"></div>

    <!-- RESUMEN DEL TOTAL -->
    <div class="cart-summary">
      <h2>Resumen de compra</h2>
      <p id="total">Total: $0.00</p>
      <button onclick="clearCart()" class="clear-btn">üóë Vaciar carrito</button>
      <a href="index.html" class="continue-btn">‚¨ÖÔ∏è Seguir comprando</a>
      <button class="checkout-btn" id="btnCheckout">‚úÖ Finalizar compra</button>
    </div>
  </div>

  <!-- =========================
       L√≥gica de carrito (localStorage) - BLOQUE 1
       ========================= -->
  <script>
  (function () {
    const raw = JSON.parse(localStorage.getItem('cart')) || [];
    function normalize(rawItem, idx) {
      return {
        id: rawItem.id ?? idx,
        nombre: rawItem.nombre ?? rawItem.name ?? "Producto",
        precio: Number(rawItem.precio ?? rawItem.price ?? 0),
        imagen: rawItem.imagen ?? rawItem.image ?? "imgpromo/placeholder.webp",
        cantidad: Number(rawItem.cantidad ?? rawItem.quantity ?? 1)
      };
    }
    let cart = raw.map(normalize);

    function saveCart() {
      localStorage.setItem("cart", JSON.stringify(cart));
      try { if (window.updateCartCount) window.updateCartCount(); } catch(_) {}
    }

    function renderCart() {
      const container = document.getElementById("cart-items");
      container.innerHTML = "";
      if (!cart.length) {
        container.innerHTML = "<p>Tu carrito est√° vac√≠o.</p>";
        document.getElementById("total").textContent = "Total: $0.00";
        return;
      }

      let total = 0;
      cart.forEach((item, i) => {
        total += item.precio * item.cantidad;
        container.insertAdjacentHTML("beforeend", `
          <div class="cart-item">
            <img src="${item.imagen}" alt="${item.nombre}" class="cart-img">
            <div class="cart-info">
              <h3>${item.nombre}</h3>
              <p>Precio: $${item.precio.toFixed(2)}</p>
              <div class="qty-control">
                <button onclick="changeQty(${i}, -1)">‚ûñ</button>
                <span>${item.cantidad}</span>
                <button onclick="changeQty(${i}, 1)">‚ûï</button>
              </div>
              <p><strong>Subtotal: $${(item.precio * item.cantidad).toFixed(2)}</strong></p>
            </div>
            <button onclick="removeFromCart(${i})">‚ùå</button>
          </div>
        `);
      });
      document.getElementById("total").textContent = "Total: $" + total.toFixed(2);
    }

    window.changeQty = function (i, delta) {
      cart[i].cantidad += delta;
      if (cart[i].cantidad <= 0) cart.splice(i, 1);
      saveCart(); renderCart();
    };
    window.removeFromCart = function (i) {
      cart.splice(i, 1);
      saveCart(); renderCart();
    };
    window.clearCart = function () {
      cart = [];
      saveCart(); renderCart();
    };

    saveCart();
    renderCart();
  })();
  </script>

  <!-- =========================
       Checkout con Stripe (opcional)
       ========================= -->
  <script type="module">
    const btn = document.getElementById("btnCheckout");
    btn?.addEventListener("click", async () => {
      const items = (JSON.parse(localStorage.getItem("cart")) || []).map(it => ({
        id: it.id,
        name: it.nombre || it.name || "Product",
        price: Number(it.precio ?? it.price ?? 0),
        quantity: Number(it.cantidad ?? it.quantity ?? 1)
      }));
      if (!items.length) { alert("Tu carrito est√° vac√≠o."); return; }

      try {
        const res = await fetch("/createCheckoutSession", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items })
        });
        const data = await res.json();
        if (!data.sessionId) throw new Error(data.error || "No se pudo crear la sesi√≥n");

        if (!window.Stripe) {
          await new Promise(r => {
            const s = document.createElement("script");
            s.src = "https://js.stripe.com/v3/";
            s.onload = r;
            document.head.appendChild(s);
          });
        }
        const stripe = Stripe(data.publicKey);
        await stripe.redirectToCheckout({ sessionId: data.sessionId });
      } catch (e) {
        alert("Error en checkout: " + e.message);
      }
    });
  </script>

  <!-- (Opcional) scripts de modales/chat si los usas en carrito -->
  <script src="js/modals.js" defer></script>
  <script src="js/chat-widget.js" defer></script>

  <!-- Firebase base -->
  <script type="module" src="js/firebase.js"></script>

  <!-- =========================
     Carrito: render y l√≥gica (BLOQUE 2 que ya ten√≠as)
     ========================= -->
  <div id="cart-root" style="max-width:1100px;margin:32px auto;padding:0 16px;">
    <h1 style="margin:8px 0 16px;">Mi Carrito</h1>
    <div id="cart-empty" style="display:none;opacity:.8;">Tu carrito est√° vac√≠o.</div>
    <div id="cart-items"></div>
    <div id="cart-summary" style="margin-top:16px;border-top:1px solid #e5e7eb;padding-top:12px;display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Subtotal</strong>
        <strong id="cart-subtotal">$0.00</strong>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
        <span>Env√≠o (estimado)</span>
        <span id="cart-shipping">$0.00</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:18px;">
        <strong>Total</strong>
        <strong id="cart-total">$0.00</strong>
      </div>
      <button id="checkout-btn" class="btn" style="margin-top:12px;">Ir a pagar</button>
    </div>
  </div>

  <script>
    (function () {
      const $ = (s, c=document) => c.querySelector(s);
      const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));

      const money = n => (Number(n)||0);
      const fmt   = n => (money(n)).toLocaleString('en-US', { style: 'currency', currency: 'USD' });

      function readCart() {
        try { return JSON.parse(localStorage.getItem('cart') || '[]'); }
        catch { return []; }
      }
      function writeCart(arr) {
        localStorage.setItem('cart', JSON.stringify(arr));
        try { if (window.updateCartCount) window.updateCartCount(); } catch {}
      }

      function removeItem(id) {
        const cart = readCart().filter(it => String(it.id) !== String(id));
        writeCart(cart); render();
      }

      function setQty(id, qty) {
        const cart = readCart();
        const idx = cart.findIndex(it => String(it.id) === String(id));
        if (idx !== -1) {
          cart[idx].quantity = Math.max(1, Number(qty)||1);
          writeCart(cart); render();
        }
      }

      function render() {
        const box       = document.getElementById('cart-items');
        const empty     = document.getElementById('cart-empty');
        const summary   = document.getElementById('cart-summary');
        const subtotalE = document.getElementById('cart-subtotal');
        const totalE    = document.getElementById('cart-total');
        const shippingE = document.getElementById('cart-shipping');

        const cart = readCart();

        if (!cart.length) {
          box.innerHTML = '';
          empty.style.display   = '';
          summary.style.display = 'none';
          writeCart(cart);
          return;
        }

        empty.style.display   = 'none';
        summary.style.display = '';

        box.innerHTML = cart.map(it => {
          const id    = it.id;
          const name  = it.name || 'Producto';
          const img   = it.image || it.img || '';
          const price = money(it.price);
          const qty   = Math.max(1, Number(it.quantity)||1);
          const line  = price * qty;

          return `
            <div class="cart-row" data-id="${id}"
                style="display:grid;grid-template-columns:92px 1fr 120px 120px 80px;gap:12px;align-items:center;border-bottom:1px solid #f3f4f6;padding:10px 0;">
              <div style="width:92px;height:92px;overflow:hidden;border-radius:8px;border:1px solid #eee;background:#fff;">
                ${img ? `<img src="${img}" alt="" style="width:100%;height:100%;object-fit:cover;">` : ''}
              </div>
              <div style="min-width:0;">
                <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${name}</div>
                <div style="opacity:.8;font-size:.9rem;">ID: ${id}</div>
              </div>
              <div style="font-weight:600;">${fmt(price)}</div>
              <div>
                <input type="number" min="1" value="${qty}" class="qty-input"
                      style="width:90px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;">
              </div>
              <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end;">
                <div style="font-weight:600;">${fmt(line)}</div>
                <button class="remove-btn" style="background:#fee2e2;border:1px solid #fecaca;border-radius:8px;padding:6px 8px;cursor:pointer;">‚úï</button>
              </div>
            </div>
          `;
        }).join('');

        const subtotal = cart.reduce((s, it) => s + money(it.price) * Math.max(1, Number(it.quantity)||1), 0);
        const shipping = 0;
        const total    = subtotal + shipping;

        subtotalE.textContent = fmt(subtotal);
        shippingE.textContent = fmt(shipping);
        totalE.textContent    = fmt(total);

        $$('.cart-row').forEach(row => {
          const id = row.getAttribute('data-id');
          const qtyInput = $('.qty-input', row);
          const rmBtn    = $('.remove-btn', row);

          qtyInput?.addEventListener('change', e => setQty(id, e.target.value));
          rmBtn?.addEventListener('click', () => removeItem(id));
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', render);
      } else { render(); }

      window.addEventListener('storage', (e) => { if (e.key === 'cart') render(); });
    })();
  </script>

</body>
</html>