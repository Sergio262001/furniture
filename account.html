<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Account | Furniture</title>

  <!-- BASE dinámico: GitHub Pages vs Hosting (Firebase/otros) -->
  <script>
    (function () {
      var REPO_SLUG = 'furniture';
      var isGH = /github\.io$/i.test(location.hostname);
      var base = document.createElement('base');
      base.href = isGH ? '/' + REPO_SLUG + '/' : '/';
      document.head.prepend(base);
      if (isGH && !location.pathname.startsWith('/' + REPO_SLUG + '/')) {
        location.replace('/' + REPO_SLUG + location.pathname + location.search + location.hash);
      }
    })();
  </script>

  <link rel="stylesheet" href="style.css"/>
  <style>
    :root{--ring:#e5e7eb;--muted:#6b7280;--fg:#111827;--ok:#065f46;--err:#b91c1c;--brand:#dc2626}
    body{background:#f8fafc}
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:24px}
    .row{display:grid;grid-template-columns:120px 1fr;gap:24px}
    .avatar{width:96px;height:96px;border-radius:50%;object-fit:cover;background:#f4f4f5;border:1px solid var(--ring)}
    .muted{color:var(--muted);font-size:.95rem}
    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input[type="text"],input[readonly]{width:100%;padding:10px 12px;border:1px solid var(--ring);border-radius:10px}
    .btn{border:0;border-radius:12px;padding:12px 16px;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-outline{background:#fff;border:1px solid var(--ring)}
    .badge{display:inline-block;background:#f3f4f6;border:1px solid var(--ring);border-radius:999px;padding:4px 10px;font-size:.85rem}
    .section{margin-top:28px}
    .header{display:flex;justify-content:space-between;align-items:center;margin:12px 0 24px}
    nav a{margin-right:16px;text-decoration:none;color:var(--fg)}
    .error{color:var(--err);margin-top:8px}
    .success{color:var(--ok);margin-top:8px}
    .kbd{border:1px solid var(--ring);border-bottom-width:2px;border-radius:8px;padding:2px 6px;display:inline-block;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .banner{display:none;margin-bottom:16px;padding:12px 14px;border:1px dashed #f59e0b;border-radius:12px;background:#fffbeb}
    .banner.show{display:flex;align-items:center;gap:12px;justify-content:space-between}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .divider{height:1px;background:#e5e7eb;margin:20px 0}
    .skeleton{background:linear-gradient(90deg,#f3f4f6, #e5e7eb, #f3f4f6);background-size:200% 100%;animation:shimmer 1.2s infinite;display:inline-block;border-radius:8px}
    @keyframes shimmer{0%{background-position:-150% 0}100%{background-position:150% 0}}
  </style>
</head>
<body>
  <header class="container" aria-label="Top navigation">
    <div class="header">
      <nav>
        <a href="index.html">Home</a>
        <a href="products.html">Products</a>
        <a href="cart.html">Cart</a>
        <a href="account.html" aria-current="page" class="badge">My Account</a>
      </nav>
      <div>
        <span class="muted" data-user-badge>Invitado</span>
        <a href="login.html" data-login-link class="btn btn-outline">Log in</a>
        <button data-logout-link class="btn btn-outline" style="display:none">Log out</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="verifyBanner" class="banner" role="status" aria-live="polite">
      <span>
        Your email is not verified. Check your inbox or
        <button id="resendLink" class="btn btn-outline" style="padding:6px 10px">Resend link</button>
      </span>
      <span class="muted">Tip: If you can’t find it, search for <span class="kbd">no-reply@firebase</span>.</span>
    </div>

    <div class="card" aria-busy="true">
      <h1>My Account</h1>
      <p class="muted">Manage your profile, sign-in methods and security.</p>

      <!-- Perfil -->
      <div class="section row">
        <div>
          <div id="avatarSk" class="skeleton" style="width:96px;height:96px"></div>
          <img id="avatar" class="avatar" src="img/avatar-default.png" alt="Avatar" hidden>
        </div>
        <div>
          <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
            <strong id="displayNameLabel">—</strong>
            <span id="providerBadge" class="badge">—</span>
          </div>

          <label for="displayName">Display name</label>
          <input id="displayName" type="text" placeholder="Your name" autocomplete="name">

          <label for="email">Email</label>
          <input id="email" type="text" readonly>

          <div class="actions">
            <button id="saveBtn" class="btn btn-primary">Save changes</button>
            <button id="logoutBtn" class="btn btn-outline">Log out</button>
            <button id="resetBtn" class="btn btn-outline" style="display:none">Reset password</button>
          </div>

          <div id="msg" class="muted" role="alert"></div>
        </div>
      </div>

      <!-- Métodos de acceso -->
      <div class="section">
        <h3>Sign-in methods</h3>
        <div class="grid-2">
          <div>
            <p class="muted">Google</p>
            <button id="btnConnectGoogle" class="btn btn-outline">Connect Google</button>
            <button id="btnDisconnectGoogle" class="btn btn-outline" style="display:none">Disconnect Google</button>
          </div>
          <div>
            <p class="muted">Email & Password</p>
            <button id="btnChangePassword" class="btn btn-outline" style="display:none">Change password</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- (Opcional) Resumen de carrito del user -->
      <div class="section">
        <h3>Quick summary</h3>
        <p class="muted" id="cartSummary">Cart: 0 items</p>
      </div>
    </div>
  </main>

  <!-- Firebase base -->
  <script type="module" src="js/firebase.js"></script>

  <!-- Lógica de la página -->
  <script type="module">
    const $ = (s) => document.querySelector(s);
    const msg = $("#msg");
    const setMsg = (text, type="") => {
      msg.textContent = text || "";
      msg.className = type === "error" ? "error" : (type === "success" ? "success" : "muted");
    };

    // SDK imports
    import { onAuthStateChanged, GoogleAuthProvider, linkWithPopup } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // API expuesta por js/firebase.js
    const { auth, getCart, saveProfile, logout, resetPassword, resendVerifyEmail, changePassword, isProviderLinked } = window.FB;

    const ui = {
      avatar: $("#avatar"),
      avatarSk: $("#avatarSk"),
      nameInput: $("#displayName"),
      nameLabel: $("#displayNameLabel"),
      email: $("#email"),
      providerBadge: $("#providerBadge"),
      resetBtn: $("#resetBtn"),
      verifyBanner: $("#verifyBanner"),
      resendLink: $("#resendLink"),
      cartSummary: $("#cartSummary"),
      btnConnectGoogle: $("#btnConnectGoogle"),
      btnDisconnectGoogle: $("#btnDisconnectGoogle"),
      btnChangePassword: $("#btnChangePassword"),
    };

    // Render inicial + redirección si no hay sesión
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "login.html"; return; }

      // Email verificado banner
      ui.verifyBanner.classList.toggle('show', !user.emailVerified);
      ui.resendLink.onclick = async () => {
        try { await resendVerifyEmail(); setMsg('Verification email sent.', 'success'); }
        catch (e) { setMsg(e.message, 'error'); }
      };

      // Avatar skeleton -> image
      ui.avatar.src = user.photoURL || "img/avatar-default.png";
      ui.avatar.hidden = false; ui.avatarSk.hidden = true;

      // Perfil básico
      ui.nameInput.value = user.displayName || "";
      ui.nameLabel.textContent = user.displayName || user.email || "Account";
      ui.email.value = user.email || "";

      // Providers
      const providers = (user.providerData||[]).map(p => p.providerId);
      const hasGoogle = providers.includes('google.com');
      const hasPassword = providers.includes('password');
      ui.providerBadge.textContent = hasGoogle ? 'Google' : (hasPassword ? 'Email/Password' : (providers[0]||'Account'));

      // Mostrar/ocultar botones por proveedor
      ui.resetBtn.style.display = hasPassword ? '' : 'none';
      ui.btnChangePassword.style.display = hasPassword ? '' : 'none';
      ui.btnConnectGoogle.style.display = hasGoogle ? 'none' : '';
      ui.btnDisconnectGoogle.style.display = hasGoogle ? '' : 'none';

      // Resumen de carrito (best-effort)
      try { const items = await getCart(); ui.cartSummary.textContent = `Cart: ${items.length} item${items.length===1?"":"s"}`; } catch {}
    });

    // Guardar cambios
    $("#saveBtn").addEventListener("click", async () => {
      setMsg("");
      const displayName = ui.nameInput.value.trim();
      try {
        await saveProfile({ displayName });
        ui.nameLabel.textContent = displayName || ui.email.value;
        setMsg("Profile updated.", "success");
      } catch (e) { setMsg(e.message, "error"); }
    });

    // Logout (top bar + card)
    const doLogout = async () => { try { await logout(); } finally { location.href = "index.html"; } };
    $("#logoutBtn").addEventListener("click", doLogout);
    document.querySelector("[data-logout-link]").addEventListener("click", doLogout);

    // Reset password
    ui.resetBtn.addEventListener("click", async () => {
      try { await resetPassword(ui.email.value); setMsg("We sent you a password reset email.", "success"); }
      catch (e) { setMsg(e.message, "error"); }
    });

    // Change password (only if password provider)
    ui.btnChangePassword.addEventListener('click', async () => {
      const newPass = prompt('New password (min 6 chars):');
      if (!newPass) return;
      try { await changePassword(newPass); setMsg('Password changed.', 'success'); }
      catch (e) { setMsg(e.message, 'error'); }
    });

    // Connect Google (link)
    ui.btnConnectGoogle.addEventListener('click', async () => {
      try {
        const provider = new GoogleAuthProvider();
        await linkWithPopup(window.FB.auth.currentUser, provider);
        setMsg('Google linked to your account.', 'success');
        location.reload();
      } catch (e) { setMsg(e.message, 'error'); }
    });

    // Disconnect Google (requires another method present)
    ui.btnDisconnectGoogle.addEventListener('click', async () => {
      try {
        const ok = await isProviderLinked('password');
        if (!ok) { setMsg('Add a password first to disconnect Google.', 'error'); return; }
        await window.FB.unlinkProvider('google.com');
        setMsg('Google disconnected.', 'success');
        location.reload();
      } catch (e) { setMsg(e.message, 'error'); }
    });
  </script>
</body>
</html>
